<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin">
	
	<update id="updateRating" parameterType="hashmap">
		UPDATE BFS_USER 
		<if test="flag=='up'">
			SET PMS='관리자', MOD_IP=#{ip}, MOD_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS') WHERE MEM_NO=#{no}
		</if>
		<if test="flag=='down'">
			SET PMS='회원', MOD_IP=#{ip}, MOD_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS') WHERE MEM_NO=#{no}
		</if>
	</update>
	
	<select id="selectUserInfo" parameterType="String" resultType="hashmap">
		<![CDATA[
			SELECT * FROM BFS_USER WHERE ID=#{id}
		]]>
	</select>
	
	<update id="updateUser" parameterType="first.shopping.admin.bean.MemberBean">
		UPDATE BFS_USER 
		SET KOR_NAME=#{kor_name},PASSWORD=#{password},
			UPDATE_ID=#{update_id},UPDATE_IP=#{update_ip},UPDATE_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS')
		WHERE ID=#{id}
	</update>
	
	<update id="updateIsDel" parameterType="hashmap">
		UPDATE BFS_USER 
		<if test="flag=='delete'">
			SET DEL_IP=#{ip}, DEL_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS'), IS_DEL='Y' WHERE MEM_NO=#{no}
		</if>
		<if test="flag=='restore'">
			SET DEL_IP=#{ip}, DEL_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS'), IS_DEL='N' WHERE MEM_NO=#{no}
		</if>
	</update>
<!-- ================================================================================ -->
	<select id="checkPw" parameterType="String" resultType="String">
		SELECT PASSWORD FROM BFS_USER WHERE ID=#{id}
	</select>
	
	<update id="updateLoginDate" parameterType="String">
		UPDATE BFS_USER
		SET LOGIN_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS')
		WHERE ID=#{id}
	</update>
	
	<insert id="signUp" parameterType="hashmap">
		INSERT INTO BFS_USER
		VALUES(#{id},#{password},#{name},'US01',#{ip},TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS'),NULL,NULL,NULL,NULL,'로그인 기록 없음')
	</insert>

	<select id="selectUserList" parameterType="hashmap" resultType="hashmap">
		SELECT * FROM 
		(SELECT ROWNUM RN,ID,PASSWORD,KOR_NAME,STATE_GB,REG_IP,REG_DATE,UPDATE_ID,UPDATE_NAME,UPDATE_IP,UPDATE_DATE,LOGIN_DATE
		 FROM(
		SELECT * FROM BFS_USER ORDER BY LOGIN_DATE DESC) ORDER BY RN)
		WHERE RN BETWEEN #{start} AND #{end}
	</select>

	<select id="searchUserList" parameterType="hashmap" resultType="hashmap">
		SELECT * FROM
		(SELECT ROWNUM RN,ID,PASSWORD,KOR_NAME,STATE_GB,REG_IP,REG_DATE,UPDATE_ID,UPDATE_NAME,UPDATE_IP,UPDATE_DATE,LOGIN_DATE
		 FROM(
		SELECT * FROM BFS_USER ORDER BY LOGIN_DATE DESC) 
		<choose>
			<when test="name != '' &amp;&amp; id == ''">
				WHERE KOR_NAME LIKE '%' || #{name} || '%' 
			</when>
			<when test="name == '' &amp;&amp; id != '' ">
				WHERE ID LIKE '%' || #{id} || '%' 
			</when>
			<when test="name != '' &amp;&amp; id != '' ">
				WHERE KOR_NAME LIKE '%' || #{name} || '%' AND ID LIKE '%' || #{id} || '%' 
			</when>
			<otherwise>
				
			</otherwise>
		</choose>
		ORDER BY RN)
		WHERE RN BETWEEN #{start} AND #{end}
	</select>
	
	<select id="getTotalRow" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) FROM BFS_USER
		<choose>
			<when test="name != null &amp;&amp; id == null ">
				WHERE KOR_NAME LIKE '%' || #{name} || '%'
			</when>
			<when test="name == null &amp;&amp; id != null ">
				WHERE ID LIKE '%' || #{id} || '%'
			</when>
			<when test="name != null &amp;&amp; id != null ">
				WHERE KOR_NAME LIKE '%' || #{name} || '%' AND ID LIKE '%' || #{id} || '%'
			</when>
			<otherwise>
				
			</otherwise>
		</choose>
	</select>
<!-- ================================================================================ -->
	
	<resultMap id="CalList" type="hashmap">
		<result property="INFO" column="INFO" jdbcType="CLOB" javaType="String" />
	</resultMap>
	
	<select id="selectCalList" resultMap="CalList">
		<![CDATA[
			SELECT  OFFER_NO , SUBSTR(OFFER_NO,1,8) WORK_DATE, SUBSTR(OFFER_NO,9,2) WORK_NUM , WORK_GB,
			        (SELECT KOR_NAME FROM BFS_CODE WHERE MAJOR_CD = 'WKGB' AND MINOR_CD = WORK_GB) WORK_KOR
			FROM    BFS_PRODUCT
			WHERE   SUBSTR(OFFER_NO,1,6) = DECODE(#{month},'12',#{year}||#{month},'11',#{year}||#{month},'10',#{year}||#{month},#{year}||'0'||#{month})
			GROUP BY OFFER_NO, WORK_GB
			ORDER BY WORK_DATE ASC
		]]>
	</select>
	
	<resultMap id="CodeList" type="hashmap">
		<result property="INFO" column="INFO" jdbcType="CLOB" javaType="String" />
	</resultMap>
	
	
	<select id="searchCodeList" resultMap="CodeList">
		SELECT * FROM 
		(SELECT ROWNUM RN, A.* FROM BFS_CODE A
		WHERE MAJOR_CD = 'PRGB'
		<if test="name != null">
			AND KOR_NAME LIKE '%' || #{name} || '%' 
		</if>
		<if test="use != null">
			AND USE_GB LIKE '%' || #{use} || '%' 
		</if>
		ORDER BY USE_GB DESC, MINOR_CD ASC)
		WHERE RN BETWEEN #{start} AND #{end}
	</select>
	
	<select id="Code_getTotalRow" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) FROM BFS_CODE
		WHERE MAJOR_CD = 'PRGB'
		<if test="name != null">
			AND KOR_NAME LIKE '%' || #{name} || '%' 
		</if>
		<if test="use != null">
			AND USE_GB LIKE '%' || #{use} || '%' 
		</if>
	</select>

	<select id="Product_getTotalRow" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(OFFER_NO) FROM (
		SELECT  OFFER_NO , WORK_GB
		FROM    BFS_PRODUCT
		WHERE   1=1
		AND SUBSTR(OFFER_NO,1,8) BETWEEN #{strdate} and #{enddate}
		AND WORK_GB LIKE '%'||#{workgb}||'%' 
		GROUP BY OFFER_NO, WORK_GB)
	</select>
	
	<resultMap id="ProductList" type="hashmap">
	<result property="INFO" column="INFO" jdbcType="CLOB" javaType="String" />
	</resultMap>
	
	
	<select id="searchProductList" resultMap="ProductList">
		SELECT  OFFER_NO
				, SUBSTR(OFFER_NO,1,4)||'년'||SUBSTR(OFFER_NO,5,2)||'월'|| SUBSTR(OFFER_NO,7,2)||'일' WORK_DATE
				, SUBSTR(OFFER_NO,9,2) WORK_NUM 
				, WORK_GB
				, (SELECT KOR_NAME FROM BFS_CODE WHERE MAJOR_CD = 'WKGB' AND MINOR_CD = WORK_GB) WORK_KOR
			FROM    BFS_PRODUCT
			WHERE   1=1
		<if test="strdate != null &amp;&amp; enddate != null">
			AND SUBSTR(OFFER_NO,1,8) BETWEEN #{strdate} and #{enddate}
		</if>
		<if test="workgb != null">
			AND WORK_GB = '#{workgb}' 
		</if>
		GROUP BY OFFER_NO, WORK_GB
		ORDER BY WORK_DATE ASC
	</select>


</mapper>

