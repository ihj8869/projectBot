<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin">
	
	<update id="updateRating" parameterType="hashmap">
		UPDATE BFS_USER 
		<if test="flag=='up'">
			SET PMS='관리자', MOD_IP=#{ip}, MOD_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS') WHERE MEM_NO=#{no}
		</if>
		<if test="flag=='down'">
			SET PMS='회원', MOD_IP=#{ip}, MOD_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS') WHERE MEM_NO=#{no}
		</if>
	</update>
	
	<select id="selectUserInfo" parameterType="String" resultType="hashmap">
		<![CDATA[
			SELECT * FROM BFS_USER WHERE ID=#{id}
		]]>
	</select>
	
	<update id="updateUser" parameterType="first.shopping.admin.bean.MemberBean">
		UPDATE BFS_USER 
		SET KOR_NAME=#{kor_name},PASSWORD=#{password},
			UPDATE_ID=#{update_id},UPDATE_IP=#{update_ip},UPDATE_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS')
		WHERE ID=#{id}
	</update>
	
	<update id="updateIsDel" parameterType="hashmap">
		UPDATE BFS_USER 
		<if test="flag=='delete'">
			SET DEL_IP=#{ip}, DEL_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS'), IS_DEL='Y' WHERE MEM_NO=#{no}
		</if>
		<if test="flag=='restore'">
			SET DEL_IP=#{ip}, DEL_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS'), IS_DEL='N' WHERE MEM_NO=#{no}
		</if>
	</update>
<!-- ================================================================================ -->
	<select id="checkPw" parameterType="String" resultType="String">
		SELECT PASSWORD FROM BFS_USER WHERE ID=#{id}
	</select>
	
	<update id="updateLoginDate" parameterType="String">
		UPDATE BFS_USER
		SET LOGIN_DATE=TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS')
		WHERE ID=#{id}
	</update>
	
	<insert id="signUp" parameterType="hashmap">
		INSERT INTO BFS_USER
		VALUES(#{id},#{password},#{name},'US01',#{ip},TO_CHAR(SYSDATE, 'YYYY/MM/DD HH24:MI:SS'),NULL,NULL,NULL,NULL,'로그인 기록 없음')
	</insert>

	<select id="selectUserList" parameterType="hashmap" resultType="hashmap">
		SELECT * FROM 
		(SELECT ROWNUM RN,ID,PASSWORD,KOR_NAME,STATE_GB,REG_IP,REG_DATE,UPDATE_ID,UPDATE_NAME,UPDATE_IP,UPDATE_DATE,LOGIN_DATE
		 FROM(
		SELECT * FROM BFS_USER ORDER BY LOGIN_DATE DESC) ORDER BY RN)
		WHERE RN BETWEEN #{start} AND #{end}
	</select>

	<select id="searchUserList" parameterType="hashmap" resultType="hashmap">
		SELECT * FROM
		(SELECT ROWNUM RN,ID,PASSWORD,KOR_NAME,STATE_GB,REG_IP,REG_DATE,UPDATE_ID,UPDATE_NAME,UPDATE_IP,UPDATE_DATE,LOGIN_DATE
		 FROM(
		SELECT * FROM BFS_USER ORDER BY LOGIN_DATE DESC) 
		<choose>
			<when test="name != '' &amp;&amp; id == ''">
				WHERE KOR_NAME LIKE '%' || #{name} || '%' 
			</when>
			<when test="name == '' &amp;&amp; id != '' ">
				WHERE ID LIKE '%' || #{id} || '%' 
			</when>
			<when test="name != '' &amp;&amp; id != '' ">
				WHERE KOR_NAME LIKE '%' || #{name} || '%' AND ID LIKE '%' || #{id} || '%' 
			</when>
			<otherwise>
				
			</otherwise>
		</choose>
		ORDER BY RN)
		WHERE RN BETWEEN #{start} AND #{end}
	</select>
	
	<select id="getTotalRow" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) FROM BFS_USER
		<choose>
			<when test="name != null &amp;&amp; id == null ">
				WHERE KOR_NAME LIKE '%' || #{name} || '%'
			</when>
			<when test="name == null &amp;&amp; id != null ">
				WHERE ID LIKE '%' || #{id} || '%'
			</when>
			<when test="name != null &amp;&amp; id != null ">
				WHERE KOR_NAME LIKE '%' || #{name} || '%' AND ID LIKE '%' || #{id} || '%'
			</when>
			<otherwise>
				
			</otherwise>
		</choose>
	</select>
<!-- ================================================================================ -->
	
	<resultMap id="CalList" type="hashmap">
		<result property="INFO" column="INFO" jdbcType="CLOB" javaType="String" />
	</resultMap>
	
	<select id="selectCalList" resultMap="CalList">
		<![CDATA[
			SELECT  OFFER_NO , SUBSTR(OFFER_NO,1,8) WORK_DATE, SUBSTR(OFFER_NO,9,2) WORK_NUM , WORK_GB,
			        (SELECT KOR_NAME FROM BFS_CODE WHERE MAJOR_CD = 'WKGB' AND MINOR_CD = WORK_GB) WORK_KOR
			FROM    BFS_PRODUCT
			WHERE   SUBSTR(OFFER_NO,1,6) = DECODE(#{month},'12',#{year}||#{month},'11',#{year}||#{month},'10',#{year}||#{month},#{year}||'0'||#{month})
			GROUP BY OFFER_NO, WORK_GB
			ORDER BY WORK_DATE ASC
		]]>
	</select>
	
	<resultMap id="CodeList" type="hashmap">
		<result property="INFO" column="INFO" jdbcType="CLOB" javaType="String" />
	</resultMap>
	
	
	<select id="searchCodeList" resultMap="CodeList">
		SELECT * FROM 
		(SELECT ROWNUM RN, A.* FROM BFS_CODE A
		WHERE MAJOR_CD = 'PRGB'
		<if test="name != null">
			AND KOR_NAME LIKE '%' || #{name} || '%' 
		</if>
		<if test="use != null">
			AND USE_GB LIKE '%' || #{use} || '%' 
		</if>
		ORDER BY USE_GB DESC, MINOR_CD ASC)
		WHERE RN BETWEEN #{start} AND #{end}
	</select>
	
	<select id="Code_getTotalRow" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) FROM BFS_CODE
		WHERE MAJOR_CD = 'PRGB'
		<if test="name != null">
			AND KOR_NAME LIKE '%' || #{name} || '%' 
		</if>
		<if test="use != null">
			AND USE_GB LIKE '%' || #{use} || '%' 
		</if>
	</select>

	<select id="Product_getTotalRow" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(OFFER_NO) FROM (
		SELECT  OFFER_NO , WORK_GB
		FROM    BFS_PRODUCT
		WHERE   1=1
		AND SUBSTR(OFFER_NO,1,8) BETWEEN #{strdate} and #{enddate}
		AND WORK_GB LIKE '%'||#{workgb}||'%' 
		GROUP BY OFFER_NO, WORK_GB)
	</select>
	
	<resultMap id="ProductList" type="hashmap">
	<result property="INFO" column="INFO" jdbcType="CLOB" javaType="String" />
	</resultMap>
	
	
	<select id="searchProductList" resultMap="ProductList">
		SELECT  OFFER_NO
				, SUBSTR(OFFER_NO,1,4)||'년'||SUBSTR(OFFER_NO,5,2)||'월'|| SUBSTR(OFFER_NO,7,2)||'일' WORK_DATE
				, SUBSTR(OFFER_NO,9,2) WORK_NUM 
				, WORK_GB
				, (SELECT KOR_NAME FROM BFS_CODE WHERE MAJOR_CD = 'WKGB' AND MINOR_CD = WORK_GB) WORK_KOR
			FROM    BFS_PRODUCT
			WHERE   1=1
		<if test="strdate != null &amp;&amp; enddate != null">
			AND SUBSTR(OFFER_NO,1,8) BETWEEN #{strdate} and #{enddate}
		</if>
		<if test="workgb != null">
			AND WORK_GB = '#{workgb}' 
		</if>
		GROUP BY OFFER_NO, WORK_GB
		ORDER BY OFFER_NO ASC
	</select>
	
	<resultMap id="ProductList_Detail" type="hashmap">
	<result property="INFO" column="INFO" jdbcType="CLOB" javaType="String" />
	</resultMap>
	

	<select id="searchProductList_Detail" resultMap="ProductList_Detail">
		<![CDATA[
			SELECT a.OFFER_NO, a.WORK_GB, a.PRO_GB 
					, (SELECT KOR_NAME FROM BFS_CODE WHERE MAJOR_CD = 'PRGB' AND MINOR_CD = a.PRO_GB) KOR_NAME 
			        , a.PRE_QTY+b.PRE_QTY PRE_TOTAL_QTY
			        , DECODE(a.QTY,-999999,0,a.QTY)+decode(b.QTY,-999999,0,b.QTY) TOTAL_QTY
			        , a.PRE_QTY PRE_QTY_ST01, DECODE(a.QTY,-999999,0,a.QTY) QTY_ST01
			        , b.PRE_QTY PRE_QTY_ST02, DECODE(b.QTY,-999999,0,b.QTY) QTY_ST02
			        , a.PRE_QTY+b.PRE_QTY+DECODE(a.QTY,-999999,0,a.QTY)+DECODE(b.QTY,-999999,0,b.QTY) END_TOTAL_QTY
			        , a.PRE_QTY+DECODE(a.QTY,-999999,0,a.QTY) END_QTY_ST01
			        , b.PRE_QTY+DECODE(b.QTY,-999999,0,b.QTY) END_QTY_ST02
			        
			FROM (
			SELECT OFFER_NO,WORK_GB,PRO_GB,SUM(PRE_QTY) PRE_QTY, SUM(QTY) QTY  FROM(
			    SELECT OFFER_NO,WORK_GB,PRO_GB,STATE_GB
			        ,NVL((SELECT SUM(QTY) FROM BFS_PRODUCT WHERE OFFER_NO < #{offer_no} AND STATE_GB = 'ST01' AND PRO_GB = A.PRO_GB),0) PRE_QTY
			        ,NVL(QTY,0) QTY
			    FROM BFS_PRODUCT A
			    WHERE OFFER_NO = #{offer_no}
			    AND STATE_GB = 'ST01'
			    UNION
			    SELECT #{offer_no} OFFER_NO,  #{work_gb} WORK_GB, PRO_GB, 'ST01' STATE_GB
			            , NVL((SELECT SUM(QTY) FROM BFS_PRODUCT WHERE OFFER_NO < #{offer_no} AND STATE_GB = 'ST01' AND PRO_GB = A.PRO_GB),0) PRE_QTY
			            , -999999 QTY
			    FROM(
			        SELECT MINOR_CD PRO_GB FROM BFS_CODE 
			        WHERE MAJOR_CD = 'PRGB'
			        AND USE_GB = 'Y'
			        MINUS
			        SELECT PRO_GB FROM BFS_PRODUCT
			        WHERE OFFER_NO = #{offer_no}
			        AND STATE_GB = 'ST01') A
			        )
			GROUP BY OFFER_NO,WORK_GB,PRO_GB) a,
			(SELECT OFFER_NO,WORK_GB,PRO_GB,SUM(PRE_QTY) PRE_QTY, SUM(QTY) QTY FROM(
			    SELECT OFFER_NO,WORK_GB,PRO_GB,STATE_GB
			        ,NVL((SELECT SUM(QTY) FROM BFS_PRODUCT WHERE OFFER_NO < #{offer_no} AND STATE_GB = 'ST02' AND PRO_GB = A.PRO_GB),0) PRE_QTY
			        ,NVL(QTY,0) QTY
			    FROM BFS_PRODUCT A
			    WHERE OFFER_NO = #{offer_no}
			    AND STATE_GB = 'ST02'
			    UNION
			    SELECT #{offer_no} OFFER_NO, #{work_gb} WORK_GB, PRO_GB, 'ST02' STATE_GB 
			            , NVL((SELECT SUM(QTY) FROM BFS_PRODUCT WHERE OFFER_NO < #{offer_no} AND STATE_GB = 'ST02' AND PRO_GB = A.PRO_GB),0) PRE_QTY
			            , -999999 QTY
			    FROM(
			        SELECT MINOR_CD PRO_GB FROM BFS_CODE 
			        WHERE MAJOR_CD = 'PRGB'
			        AND USE_GB = 'Y'
			        MINUS
			        SELECT PRO_GB FROM BFS_PRODUCT
			        WHERE OFFER_NO = #{offer_no}
			        AND STATE_GB = 'ST02') A
			        )
			GROUP BY OFFER_NO,WORK_GB,PRO_GB)b
			where a.offer_no = b.offer_no
			and  a.work_gb = b.work_gb 
			and  a.pro_gb = b.pro_gb
			ORDER BY PRO_GB ASC
		]]>
	</select>
	
	
	<select id="searchinfo" resultMap="ProductList_Detail">
		<![CDATA[
			SELECT OFFER_NO
					,A.WORK_GB
					,SUBSTR(A.OFFER_NO,1,4)||'년'||SUBSTR(A.OFFER_NO,5,2)||'월'||SUBSTR(A.OFFER_NO,7,2)||'일' WORK_DATE_KR
					,SUBSTR(A.OFFER_NO,1,8) WORK_DATE
					,(SELECT KOR_NAME 
						FROM BFS_CODE 
						WHERE MAJOR_CD = 'WKGB'
						AND MINOR_CD = A.WORK_GB) WORK_GB_KR
			FROM	BFS_PRODUCT A
			WHERE	A.OFFER_NO = #{offer_no}	
			GROUP BY A.OFFER_NO, A.WORK_GB
		]]>
	</select>
	
	


</mapper>

